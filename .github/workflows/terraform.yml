name: Terraform CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  terraform:
    runs-on: ubuntu-latest

    steps:
      # Шаг 1: Клонирование репозитория
      - name: Checkout repository
        uses: actions/checkout@v3

      # Шаг 2: Установка Terraform CLI
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: "1.8.4"

      # Шаг 3: Раскодирование Base64-секрета
      - name: Decode Base64 Secret
        run: |
          echo "${{ secrets.YC_SERVICE_ACCOUNT_KEY_BASE64 }}" | base64 --decode > key.json

      # Шаг 4: Настройка переменных окружения (если необходимо)
      - name: Configure Environment Variables
        run: |
          echo "TF_VAR_cloud_id=${{ secrets.YC_CLOUD_ID }}" >> $GITHUB_ENV
          echo "TF_VAR_folder_id=${{ secrets.YC_FOLDER_ID }}" >> $GITHUB_ENV

      # Шаг 5: Terraform Init и Apply для terr-setup
      - name: Terraform Init (terr-setup)
        working-directory: terr-setup
        run: terraform init

      - name: Terraform Apply (terr-setup)
        working-directory: terr-setup
        id: terr-setup
        run: |
          terraform apply -auto-approve


      # Шаг 6: Получение выходных переменных из terr-setup
      - name: Extract Access Key and Secret Key
        id: extract-keys
        working-directory: terr-setup
        run: |
          echo "ACCESS_KEY=$(terraform output -raw access_key)" >> $GITHUB_ENV
          echo "SECRET_KEY=$(terraform output -raw secret_key)" >> $GITHUB_ENV

      # Шаг 7: Настройка Yandex Cloud CLI
      - name: Configure Yandex Cloud CLI
        run: |
          yc config set service-account-key '{"id": "${{ env.ACCESS_KEY }}", "service_account_id": "<SERVICE_ACCOUNT_ID>", "private_key": "${{ env.SECRET_KEY }}"}'
          yc config set cloud-id ${{ secrets.YC_CLOUD_ID }}
          yc config set folder-id ${{ secrets.YC_FOLDER_ID }}

      # Шаг 8: Настройка переменных окружения для terr-infra
      - name: Configure Environment Variables for terr-infra
        run: |
          echo "TF_VAR_cloud_id=${{ secrets.YC_CLOUD_ID }}" >> $GITHUB_ENV
          echo "TF_VAR_folder_id=${{ secrets.YC_FOLDER_ID }}" >> $GITHUB_ENV
          echo "TF_VAR_service_account_key_json='{\"id\": \"${{ env.ACCESS_KEY }}\", \"service_account_id\": \"<SERVICE_ACCOUNT_ID>\", \"private_key\": \"${{ env.SECRET_KEY }}\"}'" >> $GITHUB_ENV
          echo "AWS_ACCESS_KEY_ID=${{ env.ACCESS_KEY }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ env.SECRET_KEY }}" >> $GITHUB_ENV

      # Шаг 9: Terraform Init и Apply для terr-infra
      - name: Terraform Init (terr-infra)
        working-directory: terr-infra
        run: terraform init

      - name: Terraform Apply (terr-infra)
        working-directory: terr-infra
        run: terraform apply -auto-approve

      # Шаг 10: Извлечение kubeconfig
      - name: Extract Kubeconfig
        id: extract-kubeconfig
        working-directory: terr-infra
        run: |
          echo "KUBECONFIG=$(terraform output -raw kubeconfig)" >> $GITHUB_ENV

      # Шаг 11: Запись kubeconfig в ~/.kube/config
      - name: Save Kubeconfig to Local File
        run: |
          mkdir -p ~/.kube
          echo "$KUBECONFIG" > ~/.kube/config
          chmod 600 ~/.kube/config
          echo "Kubeconfig saved to ~/.kube/config"

      # Шаг 12: Проверка kubectl (опционально)
      - name: Test kubectl Connection
        run: |
          kubectl get nodes
